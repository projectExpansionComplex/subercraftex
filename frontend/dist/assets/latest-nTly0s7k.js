import{q as Q,i as G,u as I,a as _,r as o,h as p,y as V,j as e,L as P,b as i}from"./index-DuCqjSN_.js";import{l as H}from"./lodash-QbhainP2.js";const W=()=>{const{topic_uid:c}=Q(),E=G(),l=I(),{current_user:J,auth_token:n}=_(t=>t.auth),{theme:s}=_(t=>t.preferences),[F,L]=o.useState([]),[r,b]=o.useState(null),[d,R]=o.useState("all"),[u,x]=o.useState(1),[y,U]=o.useState(1),[q,g]=o.useState(!1),[v,m]=o.useState(null),[j,w]=o.useState(""),[N,S]=o.useState(""),[k,C]=o.useState(""),[$,A]=o.useState(""),T=o.useCallback(async()=>{g(!0),m(null);try{const t=await p.get("http://localhost:1337/api/forum-topics",{params:{category:d!=="all"?d:void 0,page:u,search:$}});L(t.data.data),U(t.data.pagination.total_pages)}catch(t){m("Failed to fetch forum topics. Please try again later."),console.error("Error fetching forum topics:",t)}g(!1)},[d,u,$]),f=o.useCallback(async t=>{g(!0),m(null);try{const a=await p.get(`http://localhost:1337/api/forum-topics/${t}`);b(a.data)}catch(a){m("Failed to fetch topic details. Please try again later."),console.error("Error fetching topic details:",a)}g(!1)},[]);o.useEffect(()=>{c?f(c):T()},[c,T,f]),o.useEffect(()=>{let t;if(n)return t=V("http://localhost:1337",{auth:{token:n}}),t.on("new_forum_reply",a=>{r&&a.topic_uid===r.uid&&b(h=>({...h,replies:[...h.replies,a.reply]}))}),()=>{t.disconnect()}},[n,r]);const B=async t=>{if(t.preventDefault(),!n){l(i({id:Date.now().toString(),type:"error",message:"You must be logged in to create a topic."}));return}try{const a=await p.post("http://localhost:1337/api/forum-topics",{title:j,content:N,category:d},{headers:{Authorization:`Bearer ${n}`}});w(""),S(""),l(i({id:Date.now().toString(),type:"success",message:"Topic created successfully!"})),E(`/forum/${a.data.uid}`)}catch(a){l(i({id:Date.now().toString(),type:"error",message:"Failed to create topic. Please try again."})),console.error("Error creating topic:",a)}},Y=async t=>{if(t.preventDefault(),!n||!r){l(i({id:Date.now().toString(),type:"error",message:"You must be logged in to reply."}));return}try{const a=await p.post("http://localhost:1337/api/forum-replies",{topic_uid:r.uid,content:k},{headers:{Authorization:`Bearer ${n}`}});C(""),b(h=>({...h,replies:[...h.replies,a.data]})),l(i({id:Date.now().toString(),type:"success",message:"Reply posted successfully!"}))}catch(a){l(i({id:Date.now().toString(),type:"error",message:"Failed to post reply. Please try again."})),console.error("Error posting reply:",a)}},D=async t=>{if(!n){l(i({id:Date.now().toString(),type:"error",message:"You must be logged in to upvote."}));return}try{await p.post(`http://localhost:1337/api/forum-posts/${t}/upvote`,{},{headers:{Authorization:`Bearer ${n}`}}),l(i({id:Date.now().toString(),type:"success",message:"Upvote recorded!"})),r&&f(r.uid)}catch(a){l(i({id:Date.now().toString(),type:"error",message:"Failed to upvote. Please try again."})),console.error("Error upvoting:",a)}},z=H.debounce(t=>{A(t),x(1)},300),M=t=>{z(t.target.value)};return e.jsxs("div",{className:`container mx-auto px-4 py-8 ${s==="dark"?"bg-gray-900 text-white":"bg-white text-gray-900"}`,children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Community Forum"}),!c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 flex flex-wrap items-center justify-between",children:[e.jsx("div",{className:"w-full md:w-auto mb-4 md:mb-0",children:e.jsxs("select",{value:d,onChange:t=>R(t.target.value),className:`border rounded px-3 py-2 ${s==="dark"?"bg-gray-800 border-gray-700":"bg-white border-gray-300"}`,children:[e.jsx("option",{value:"all",children:"All Categories"}),e.jsx("option",{value:"general",children:"General"}),e.jsx("option",{value:"design",children:"Design"}),e.jsx("option",{value:"development",children:"Development"})]})}),e.jsx("div",{className:"w-full md:w-auto",children:e.jsx("input",{type:"text",placeholder:"Search topics...",onChange:M,className:`border rounded px-3 py-2 w-full md:w-64 ${s==="dark"?"bg-gray-800 border-gray-700":"bg-white border-gray-300"}`})})]}),q?e.jsx("p",{className:"text-center",children:"Loading topics..."}):v?e.jsx("p",{className:"text-red-500 text-center",children:v}):e.jsx("div",{className:"space-y-4",children:F.map(t=>e.jsxs("div",{className:`border rounded p-4 ${s==="dark"?"border-gray-700":"border-gray-300"}`,children:[e.jsx(P,{to:`/forum/${t.uid}`,className:"text-xl font-semibold hover:underline",children:t.title}),e.jsxs("p",{className:"text-sm mt-2",children:["Posted by ",t.author.name," in ",t.category," • ",t.replies_count," replies"]}),e.jsxs("p",{className:"text-sm mt-1",children:["Last activity: ",new Date(t.last_activity).toLocaleString()]})]},t.uid))}),e.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[e.jsx("button",{onClick:()=>x(t=>Math.max(t-1,1)),disabled:u===1,className:`px-4 py-2 rounded ${s==="dark"?"bg-blue-600 text-white hover:bg-blue-700":"bg-blue-500 text-white hover:bg-blue-600"} disabled:opacity-50`,children:"Previous"}),e.jsxs("span",{children:["Page ",u," of ",y]}),e.jsx("button",{onClick:()=>x(t=>Math.min(t+1,y)),disabled:u===y,className:`px-4 py-2 rounded ${s==="dark"?"bg-blue-600 text-white hover:bg-blue-700":"bg-blue-500 text-white hover:bg-blue-600"} disabled:opacity-50`,children:"Next"})]}),e.jsxs("div",{className:"mt-8",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Create New Topic"}),e.jsxs("form",{onSubmit:B,children:[e.jsx("input",{type:"text",value:j,onChange:t=>w(t.target.value),placeholder:"Topic Title",className:`w-full border rounded px-3 py-2 mb-4 ${s==="dark"?"bg-gray-800 border-gray-700":"bg-white border-gray-300"}`,required:!0}),e.jsx("textarea",{value:N,onChange:t=>S(t.target.value),placeholder:"Topic Content",className:`w-full border rounded px-3 py-2 mb-4 h-32 ${s==="dark"?"bg-gray-800 border-gray-700":"bg-white border-gray-300"}`,required:!0}),e.jsx("button",{type:"submit",className:`px-4 py-2 rounded ${s==="dark"?"bg-green-600 text-white hover:bg-green-700":"bg-green-500 text-white hover:bg-green-600"}`,children:"Create Topic"})]})]})]}),c&&r&&e.jsxs("div",{children:[e.jsx(P,{to:"/forum",className:"text-blue-500 hover:underline mb-4 inline-block",children:"← Back to Topics"}),e.jsx("h2",{className:"text-2xl font-bold mb-4",children:r.title}),e.jsxs("div",{className:`border rounded p-4 mb-6 ${s==="dark"?"border-gray-700":"border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("img",{src:r.author.avatar_url||"https://via.placeholder.com/40",alt:r.author.name,className:"w-10 h-10 rounded-full mr-3"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:r.author.name}),e.jsx("p",{className:"text-sm",children:new Date(r.created_at).toLocaleString()})]})]}),e.jsx("p",{className:"mt-2",children:r.content}),e.jsx("button",{onClick:()=>D(r.uid),className:`mt-4 px-3 py-1 rounded ${s==="dark"?"bg-gray-700 text-white hover:bg-gray-600":"bg-gray-200 text-gray-800 hover:bg-gray-300"}`,children:"Upvote"})]}),e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Replies"}),r.replies.map(t=>e.jsxs("div",{className:`border rounded p-4 mb-4 ${s==="dark"?"border-gray-700":"border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("img",{src:t.author.avatar_url||"https://via.placeholder.com/40",alt:t.author.name,className:"w-8 h-8 rounded-full mr-2"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.author.name}),e.jsx("p",{className:"text-sm",children:new Date(t.created_at).toLocaleString()})]})]}),e.jsx("p",{className:"mt-2",children:t.content}),e.jsx("button",{onClick:()=>D(t.uid),className:`mt-2 px-3 py-1 rounded ${s==="dark"?"bg-gray-700 text-white hover:bg-gray-600":"bg-gray-200 text-gray-800 hover:bg-gray-300"}`,children:"Upvote"})]},t.uid)),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Post a Reply"}),e.jsxs("form",{onSubmit:Y,children:[e.jsx("textarea",{value:k,onChange:t=>C(t.target.value),placeholder:"Your reply",className:`w-full border rounded px-3 py-2 mb-4 h-32 ${s==="dark"?"bg-gray-800 border-gray-700":"bg-white border-gray-300"}`,required:!0}),e.jsx("button",{type:"submit",className:`px-4 py-2 rounded ${s==="dark"?"bg-green-600 text-white hover:bg-green-700":"bg-green-500 text-white hover:bg-green-600"}`,children:"Post Reply"})]})]})]})]})};export{W as default};
